<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --success-color: #2ecc71;
      --text-color: #333;
      --light-gray: #f5f5f5;
    }
    
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      padding: 0;
      margin: 0;
      direction: rtl;
      background-color: var(--light-gray);
      color: var(--text-color);
    }
    
    .app-header {
      background-color: var(--primary-color);
      color: white;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .logo {
      height: 60px;
      margin-left: 15px;
    }
    
    .app-title {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }
    
    .container {
      max-width: 1400px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    .section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border: 1px dashed #ddd;
    }
    
    .section-title {
      margin-top: 0;
      color: var(--secondary-color);
      font-size: 18px;
    }
    
    input[type="file"] {
      margin: 10px 0;
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    button {
      background: var(--secondary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #2980b9;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
    }
    
    th {
      background-color: var(--secondary-color);
      color: white;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    
    .danger {
      background-color: #ffdddd !important;
    }
    
    .warning {
      background-color: #fff3cd !important;
    }
    
    .safe {
      background-color: #ddffdd !important;
    }
    
    .status-need {
      color: var(--danger-color);
      font-weight: bold;
    }
    
    .status-idle {
      color: var(--warning-color);
      font-weight: bold;
    }
    
    .alert {
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }
    
    .alert-danger {
      background-color: #ffdddd;
      border-right: 5px solid var(--danger-color);
    }
    
    .alert-warning {
      background-color: #fff3cd;
      border-right: 5px solid var(--warning-color);
    }
    
    .alert-success {
      background-color: #ddffdd;
      border-right: 5px solid var(--success-color);
    }
    
    .file-name {
      font-size: 12px;
      color: #7f8c8d;
      text-align: center;
      margin-top: 5px;
    }
    
    .action-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .search-container {
      position: relative;
      margin: 20px 0;
      width: 100%;
      max-width: 500px;
    }

    #medicineSearch {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }

    #medicineSearch:focus {
      border-color: #2E7D32;
    }

    #searchSuggestions {
      display: none;
      position: absolute;
      width: 100%;
      max-height: 250px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
    }

    .suggestion-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background-color: #f5f5f5;
    }

    .suggestion-item .highlight {
      color: #2E7D32;
      font-weight: bold;
    }

    .no-results {
      padding: 10px 15px;
      color: #757575;
    }
    
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }
      
      .logo-container {
        margin-bottom: 10px;
      }
      
      .container {
        padding: 10px;
      }
      
      table {
        font-size: 12px;
      }
      
      th, td {
        padding: 5px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="app-header">
    <div class="header-content">
      <div class="logo-container">
        <img src="https://raw.githubusercontent.com/tahasalim555/pharmacy-inventory/main/eha-logo.jpg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù‡ÙŠØ¦Ø©" style="height: 80px;">
        <h1 class="app-title">Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ</h1>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="section">
      <h3 class="section-title">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</h3>
      <input type="file" id="inventoryFile" accept=".xlsx, .xls">
      <div id="inventoryFileName" class="file-name"></div>
      <p>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ§Ø¡ØŒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
    </div>

    <div class="section">
      <h3 class="section-title">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù…Ù†ØµØ±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
      <input type="file" id="consumptionFile" accept=".xlsx, .xls">
      <div id="consumptionFileName" class="file-name"></div>
      <p>ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ØŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©</p>
    </div>

    <div class="action-buttons">
      <button onclick="processData()">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</button>
      <button onclick="downloadExcel()" id="downloadBtn" disabled>ğŸ’¾ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Excel</button>
    </div>

    <div id="alerts"></div>

    <div class="section">
      <h3 class="section-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
      <div class="search-container">
        <input 
          type="text" 
          id="medicineSearch" 
          placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡ (Ø§Ø³ØªØ®Ø¯Ù… % Ù„Ù„Ø­Ø±ÙˆÙ ØºÙŠØ± Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©)..."
          autocomplete="off"
        >
        <div id="searchSuggestions"></div>
      </div>
      <div id="reportDate" style="text-align: center; margin-bottom: 10px; font-weight: bold;"></div>
      <div style="overflow-x: auto;">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
              <th>Ø£Ø¹Ù„Ù‰ 3 Ø´Ù‡ÙˆØ±</th>
              <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</th>
              <th>Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†</th>
              <th>Ø­Ø¯ Ø§Ù„Ø®Ø·Ø±</th>
              <th>Ø­Ø¯ Ø§Ù„ÙƒÙØ§ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
              <th>Ø§Ù„Ù…Ù†ØµØ±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
              <th>ÙƒÙ…ÙŠØ© Ø§Ù„Ø·Ù„Ø¨</th>
              <th>Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ†Ù</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let medicineNames = [];
    let analysisResults = [];

    document.getElementById('inventoryFile').addEventListener('change', function(e) {
      document.getElementById('inventoryFileName').textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ' + (e.target.files[0]?.name || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù');
    });

    document.getElementById('consumptionFile').addEventListener('change', function(e) {
      document.getElementById('consumptionFileName').textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ' + (e.target.files[0]?.name || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù');
    });

    function processData() {
      const inventoryFile = document.getElementById('inventoryFile').files[0];
      if (!inventoryFile) {
        alert("ÙŠØ¬Ø¨ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const inventoryData = XLSX.utils.sheet_to_json(sheet);

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù„Ù„Ø¨Ø­Ø«
        medicineNames = inventoryData.map(item => item['Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡'] || item['Ø§Ù„ØµÙ†Ù'] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');

        const consumptionFile = document.getElementById('consumptionFile').files[0];
        if (consumptionFile) {
          processConsumptionFile(consumptionFile, inventoryData);
        } else {
          calculateIndicators(inventoryData);
        }
      };
      reader.readAsArrayBuffer(inventoryFile);
    }

    function processConsumptionFile(file, inventoryData) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const consumptionData = XLSX.utils.sheet_to_json(sheet);

        consumptionData.forEach(item => {
          const drugName = item['Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡'] || item['Ø§Ù„ØµÙ†Ù'];
          const quantity = parseFloat(item['Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ù„ÙƒØ©'] || item['Ø§Ù„Ù…Ù†ØµØ±Ù'] || 0);

          const drugIndex = inventoryData.findIndex(d => (d['Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡'] || d['Ø§Ù„ØµÙ†Ù']) === drugName);
          if (drugIndex !== -1) {
            inventoryData[drugIndex]['Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ'] = (parseFloat(inventoryData[drugIndex]['Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0) - quantity;
          }
        });

        calculateIndicators(inventoryData);
      };
      reader.readAsArrayBuffer(file);
    }

    function calculateIndicators(data) {
      const today = new Date();
      document.getElementById('reportDate').textContent = 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + today.toLocaleDateString('ar-EG');

      analysisResults = data.map(item => {
        const consumptionValues = [];
        for (const key in item) {
          if (key !== 'Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡' && key !== 'Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ§Ø¡' && key !== 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ' && !isNaN(item[key])) {
            consumptionValues.push(parseFloat(item[key]));
          }
        }

        const top3 = [...consumptionValues].sort((a, b) => b - a).slice(0, 3);
        const avgConsumption = top3.reduce((sum, val) => sum + val, 0) / 3;
        const safeThreshold = avgConsumption * 0.5;
        const dangerThreshold = avgConsumption * 0.25;

        const drugType = item['Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ§Ø¡'] || 'Ù…ØªÙ†ÙˆØ¹';
        const sufficiencyThreshold = drugType === 'Ø¹Ø§Ø¯ÙŠ' ? avgConsumption * 2 : avgConsumption * 3;

        const currentStock = parseFloat(item['Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ']) || 0;
        const orderQuantity = Math.max(0, sufficiencyThreshold - currentStock);

        const status = currentStock > sufficiencyThreshold ? 'Ø±Ø§ÙƒØ¯' : 'Ø§Ø­ØªÙŠØ§Ø¬';
        const statusClass = status === 'Ø§Ø­ØªÙŠØ§Ø¬' ? 'status-need' : 'status-idle';

        return {
          name: item['Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡'] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
          type: drugType,
          top3: top3,
          avg: avgConsumption.toFixed(2),
          safe: safeThreshold.toFixed(2),
          danger: dangerThreshold.toFixed(2),
          sufficiency: sufficiencyThreshold.toFixed(2),
          stock: item['Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ'],
          dailyConsumption: item['Ø§Ù„Ù…Ù†ØµØ±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ'] || '0',
          remaining: currentStock.toFixed(2),
          order: orderQuantity.toFixed(2),
          status: status,
          statusClass: statusClass,
          rowClass: currentStock <= dangerThreshold ? 'danger' :
                   currentStock <= safeThreshold ? 'warning' : 'safe'
        };
      });

      document.getElementById('downloadBtn').disabled = false;
      displayResults(analysisResults);
      initSearch();
    }

    function displayResults(results) {
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';

      let criticalItems = [];
      let warningItems = [];

      results.forEach(item => {
        const row = document.createElement('tr');
        row.className = item.rowClass;

        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.type}</td>
          <td>${item.top3.join(', ')}</td>
          <td>${item.avg}</td>
          <td>${item.safe}</td>
          <td>${item.danger}</td>
          <td>${item.sufficiency}</td>
          <td>${item.stock}</td>
          <td>${item.dailyConsumption}</td>
          <td>${item.remaining}</td>
          <td>${item.order}</td>
          <td class="${item.statusClass}">${item.status}</td>
        `;

        tbody.appendChild(row);

        if (item.rowClass === 'danger') {
          criticalItems.push(item);
        } else if (item.rowClass === 'warning') {
          warningItems.push(item);
        }
      });

      displayAlerts(criticalItems, warningItems);
    }

    function displayAlerts(criticalItems, warningItems) {
      const alertsDiv = document.getElementById('alerts');
      alertsDiv.innerHTML = '';

      if (criticalItems.length > 0) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = `
          <h3>ğŸš¨ ${criticalItems.length} Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø®Ø·Ø±</h3>
          <ul>
            ${criticalItems.map(item => `
              <li><strong>${item.name}</strong> - Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${item.remaining} (Ø­Ø¯ Ø§Ù„Ø®Ø·Ø±: ${item.danger})</li>
            `).join('')}
          </ul>
        `;
        alertsDiv.appendChild(alert);
      }

      if (warningItems.length > 0) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-warning';
        alert.innerHTML = `
          <h3>âš ï¸ ${warningItems.length} Ø£Ø¯ÙˆÙŠØ© ØªØ­Øª Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†</h3>
          <ul>
            ${warningItems.map(item => `
              <li><strong>${item.name}</strong> - Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${item.remaining} (Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†: ${item.safe})</li>
            `).join('')}
          </ul>
        `;
        alertsDiv.appendChild(alert);
      }

      if (criticalItems.length === 0 && warningItems.length === 0) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success';
        alert.innerHTML = `
          <h3>âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø¢Ù…Ù†</h3>
        `;
        alertsDiv.appendChild(alert);
      }
    }

    function downloadExcel() {
      if (!analysisResults || analysisResults.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ØªÙ†Ø²ÙŠÙ„.");
        return;
      }

      const wsData = [
        ["Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡", "Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙˆØ§Ø¡", "Ø£Ø¹Ù„Ù‰ 3 Ø´Ù‡ÙˆØ±", "Ù…ØªÙˆØ³Ø· Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ", "Ø­Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†", "Ø­Ø¯ Ø§Ù„Ø®Ø·Ø±", "Ø­Ø¯ Ø§Ù„ÙƒÙØ§ÙŠØ©", "Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ", "Ø§Ù„Ù…Ù†ØµØ±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ", "Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©", "ÙƒÙ…ÙŠØ© Ø§Ù„Ø·Ù„Ø¨", "Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ†Ù"],
        ...analysisResults.map(item => [
          item.name, item.type, item.top3.join(', '), item.avg, item.safe, item.danger,
          item.sufficiency, item.stock, item.dailyConsumption, item.remaining, item.order, item.status
        ])
      ];

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");

      const today = new Date().toISOString().split('T')[0];
      const filename = `ØªØ­Ù„ÙŠÙ„_Ø§Ù„Ù…Ø®Ø²ÙˆÙ†_${today}.xlsx`;

      XLSX.writeFile(wb, filename);
    }

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
    function initSearch() {
      const searchInput = document.getElementById('medicineSearch');
      const suggestionsContainer = document.getElementById('searchSuggestions');

      // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø¯Ø¹Ù… %
      function searchMedicines(query) {
        if (!query) return [];
        
        const regexPattern = query
          .replace(/%/g, '.')  // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ % Ø¨Ù€ . (Ø£ÙŠ Ø­Ø±Ù)
          .replace(/\s+/g, '.*');
          
        const regex = new RegExp(regexPattern, 'i');
        return medicineNames.filter(name => regex.test(name));
      }

      // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
      function showSuggestions(results, query) {
        suggestionsContainer.innerHTML = '';
        
        if (results.length === 0) {
          suggestionsContainer.innerHTML = '<div class="no-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
          suggestionsContainer.style.display = 'block';
          return;
        }
        
        results.forEach(medicine => {
          const suggestionItem = document.createElement('div');
          suggestionItem.className = 'suggestion-item';
          
          // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚
          const highlightedText = medicine.replace(
            new RegExp(query.replace(/%/g, '.'), 'gi'),
            match => `<span class="highlight">${match}</span>`
          );
          
          suggestionItem.innerHTML = highlightedText;
          suggestionItem.addEventListener('click', () => {
            searchInput.value = medicine;
            filterTable(medicine);
            suggestionsContainer.style.display = 'none';
          });
          
          suggestionsContainer.appendChild(suggestionItem);
        });
        
        suggestionsContainer.style.display = 'block';
      }

      // ØªØµÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„
      function filterTable(searchTerm) {
        const rows = document.querySelectorAll('#resultsTable tr');
        const regex = new RegExp(searchTerm.replace(/%/g, '.'), 'i');
        
        rows.forEach((row, index) => {
          if (index === 0) return; // ØªØ®Ø·ÙŠ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
          
          const medicineName = row.cells[0].textContent;
          row.style.display = regex.test(medicineName) ? '' : 'none';
        });
      }

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø«
      searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        const results = searchMedicines(query);
        showSuggestions(results, query);
      });

      document.addEventListener('click', function(e) {
        if (e.target !== searchInput) {
          suggestionsContainer.style.display = 'none';
        }
      });

      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          filterTable(this.value);
          suggestionsContainer.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
